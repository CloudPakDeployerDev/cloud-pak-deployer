---
- name: Login to IBM Cloud
  include_role:
    name: login-ibmcloud

- name: Validate if the OpenShift cluster {{ current_openshift_cluster.name }} exists
  command: "ibmcloud oc cluster get -c {{ current_openshift_cluster.name }} --output json"
  register: _ibmcloud_oc_cluster_result_json
  failed_when: false

# If the cluster was found, delete the OcsCluster CR
- block:
  - name: Download and activate OpenShift client for version {{ current_openshift_cluster.ocp_version }}
    include_role:
      name: openshift-download-client
    vars:
      _p_ocp_version: "{{ current_openshift_cluster.ocp_version }}"

  - name: Login to the OpenShift cluster {{ current_openshift_cluster.name }}
    include_role:
      name: openshift-login
    vars:
      openshift_cluster_name: "{{ current_openshift_cluster.name }}"

  - name: Check if OcsCluster custom resource exists
    command: |
      oc get OcsCluster
    failed_when: False
    register: ocs_cluster_exists

  - name: Show OcsCluster objects
    debug:
      var: ocs_cluster_exists

  - name: Delete all OcsCluster custom resources
    command: |
      oc delete OcsCluster --all
    when: ocs_cluster_exists.rc == 0
  when: _ibmcloud_oc_cluster_result_json.rc == 0
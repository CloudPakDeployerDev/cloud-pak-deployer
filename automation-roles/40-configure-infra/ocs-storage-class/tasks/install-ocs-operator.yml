---
- name: Create openshift-storage OpenShift project
  shell: |
    if ! oc get ns openshift-storage > /dev/null 2>&1;then
      oc create ns openshift-storage
    fi

- name: Create temporary file for the OCS operator
  tempfile:
    path: "{{status_dir}}/openshift"
    state: file
  register: _ocs_operator_tempfile

- name: Generate OCS operator file {{ _ocs_operator_tempfile.path }}
  template:
    src: ocs-operator.j2
    dest: "{{ _ocs_operator_tempfile.path }}"

- name: Create OCS operator
  shell: |
    oc apply -f {{ _ocs_operator_tempfile.path }}

- name: Wait until OCS Operator CSV has status Succeeded
  shell: |
     oc get csv -n openshift-storage \
      -l operators.coreos.com/ocs-operator.openshift-storage \
      --no-headers \
      -o custom-columns='name:metadata.name,phase:status.phase' | \
      grep -i succeeded | wc -l
  register: _ocs_csv_status
  retries: 30
  delay: 30
  until: _ocs_csv_status.stdout == "1"
  vars:
    ansible_callback_diy_runner_retry_msg: >-
      {%- set result = ansible_callback_diy.result.output -%}
      {%- set retries_left = result.retries - result.attempts -%}
      Retrying: {{ ansible_callback_diy.task.name }} ({{ retries_left }} Retries left) ...

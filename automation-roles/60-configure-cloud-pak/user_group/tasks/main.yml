---
- debug:
    var: cp4d_user_group

- name: Get Route to Cloud Pak for Data
  shell: "oc --namespace {{ current_cp4d_cluster.project }} get route {{ current_cp4d_cluster.project }}-cpd -o jsonpath=\"{.spec.host}\""
  register: cp4d_url

- set_fact:
    roles_assignments: '{{ cp4d_user_group.role_assigmnents | json_query("@.name") | join(";") }}'
    ldap_group_mappings: '{{ cp4d_user_group.ldap_groups | json_query("@.name") | join(";") }}'

- debug:
    var: "{{ roles_assignments }}"

- debug:
    var: "{{ ldap_group_mappings }}"

- name: "Create CP4D User Group {{ cp4d_user_group.name }} and set authorized LDAP groups. Log file for result {{status_dir}}/log/cp4d_{{ current_cp4d_cluster.openshift_cluster_name }}_{{ current_cp4d_cluster.project }}_user_groups.log"
  script: |
    runcpdusergroup () { \
      assign_user_group_authorization.sh \
         https://{{ cp4d_url.stdout }} \
         {{ cp4d_login_username }} \
         "{{ cp4d_login_password }}" \
         "{{ cp4d_user_group.name }}" \
         "{{ cp4d_user_group.description }}" \
         "{{ roles_assignments }}" \
         "{{ ldap_group_mappings }}" |& \
         tee -a {{status_dir}}/log/cp4d_{{ current_cp4d_cluster.openshift_cluster_name }}_{{ current_cp4d_cluster.project }}_user_groups.log; \
         return "${PIPESTATUS[0]}"; }; \
    runcpdusergroup  
  register: cpd_user_group_result

- debug: 
    var: "{{ cpd_user_group_result }}"


---
- debug:
    msg: "Handling configuration for CP4D cluster {{ current_cp4d_cluster.project }}"

- name: Login to Cloud Pak for Data
  include_tasks: cluster-configure-prepare.yml

# Cartridge: DB2
- name: Provision DB2 instances
  include_role:
    name: provision_db2_instance

# Cartridge: CA
- name: Provision Cognos instances
  include_role:
    name: provision_cognos_instance

# Cartridge: DV
- name: Provision Data Virtualization instances
  include_role:
    name: provision_dv_instance

# Handle instance configurations
- when: "all_config.cp4d_instance_configuration is defined"
  block:
    - set_fact:
        cp4d_instance_config: "{{ all_config.cp4d_instance_configuration|json_query(query_instance_config) | first }}"
      vars:
        query_instance_config: "[?openshift_cluster_name=='{{ current_cp4d_cluster.openshift_cluster_name }}' && project=='{{ current_cp4d_cluster.project }}']"    

    - debug:
        msg: "{{ cp4d_instance_config }}"    

    - name: Configure CP4D instance authorization
      include_role:
        name: instance_configuration
      loop: "{{ cp4d_instance_config.cartridges | default([]) }}"
      loop_control:
        loop_var: cp4d_instance
---
- set_fact:
    _cpd_edb_instance_name: "{{ _cpd_edb_instance.metadata.name }}"
    _cpd_edb_cartridge_listed: {}
    _delete_edb_instance: False

# If not all instances must be deleted, check if instance still in the configuration
- block:
  - set_fact:
      _cpd_edb_cartridge_listed: "{{ _cpd_edb_cartridge.instances | json_query(_query_instance) | first | default({}) }}"
    vars:
      _query_instance: "[?name=='{{ _cpd_edb_instance_name }}']" 
    when: _cpd_edb_cartridge.instances is defined
  - set_fact:
      _delete_edb_instance: True
    when: _cpd_edb_cartridge_listed == {}
  when: (_p_delete_all_instances | default(False)) == False

- name: Fail if EnterpriseDB instance will be deleted and destroy is not confirmed
  fail:
    msg: "Flag --confirm-destroy was set to False, will not delete EnterpriseDB instance {{ _cpd_edb_instance_name }}"
  when:
  - _delete_edb_instance | bool
  - confirm_destroy | default (False) | bool == False

- name: "Deleting EnterpriseDB {{ _cpd_edb_instance_name }}"
  shell: |
    oc delete CPDEdbInstance -n {{ current_cp4d_cluster.project }} \
      {{ _cpd_edb_instance_name }}
  when: _delete_edb_instance | bool
---
- set_fact:
    cp4d_admin_password_vault_key_name: "cp4d_admin_{{ current_cp4d_cluster.project| replace('-','_') }}_{{ current_cp4d_cluster.openshift_cluster_name| replace('-','_') }}"

- name: Validate if an existing admin password for {{ cp4d_admin_password_vault_key_name }} exists in the vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ cp4d_admin_password_vault_key_name }}"
    secret_group: "{{ environment_name }}"

- name: Keep admin password
  set_fact:
    _cp4d_login_password: "{{ secret_value }}"

- name: Error if no secret value is returned
  fail: msg="Unable to acquire secret value for {{ cp4d_admin_password_vault_key_name }} from group {{ environment_name }}"
  when: "secret_value==''"

- name: Get Route to Cloud Pak for Data
  shell: |
    oc --namespace {{ current_cp4d_cluster.project }} get route -l component=ibm-nginx \
        -o jsonpath="{.items[0].spec.host}"
  register: cp4d_url

- name: Login to Cloud Pak for Data using password in OpenShift secret
  uri:
    url: 'https://{{ cp4d_url.stdout }}/icp4d-api/v1/authorize'
    method: POST
    body_format: json
    body: '{"username":"{{ cp4d_login_username }}","password":"{{ _cp4d_login_password }}"}'
    force: yes
    return_content: yes
    validate_certs: no
    status_code: 200
  register: _cp4d_login_result
  retries: 3
  delay: 5
  until: _cp4d_login_result.status == 200

- set_fact:
    cp4d_login: "{{ _cp4d_login_result.json }}"

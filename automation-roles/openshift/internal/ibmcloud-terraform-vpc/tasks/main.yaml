---
- name: "Create Terraform directory {{status_dir}}/terraform"
  file:
    path: "{{status_dir}}/terraform"
    state: directory

- name: Generate or retrieve the SSH keys
  include: ibmcloud-vpc-ssh.yaml
  loop: "{{ vpc_config.ssh_keys }}"

- name: "Copy variables to Terraform directory {{status_dir}}/terraform"
  template:
    src: 'variables.auto.tfvars.j2'
    dest: '{{status_dir}}/terraform/variables.auto.tfvars'

- name: "Include 'generators'-role and pass variables to it"
  include_role:
    name: generators
  vars:
    path_to_config_folder: "{{ config_dir }}/generator_config"
    path_to_definitions_folder: "{{ config_dir }}/config"
    path_to_terraform_folder: "{{status_dir}}/terraform"

- name: "Run terraform init in Terraform directory {{status_dir}}/terraform"
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: 'terraform init'

- name: "Run terraform plan in Terraform directory {{status_dir}}/terraform, check plan.log"
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: bash -c "terraform plan 2>&1 >> plan.log"

- fail:

- name: "Run terraform apply in Terraform directory {{status_dir}}/terraform, check apply.log"
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: bash -c "terraform apply -auto-approve 2>&1 >> apply.log"
---
- name: Create temporary terraform directory if it does not exist
  file:
    path: "{{status_dir}}/terraform"
    state: directory

- name: Run pre-processing script
  script: scripts/generate_management.py {{input_dir}} "{{status_dir}}/terraform/main.tf.json"
  args:
    executable: python3
  register: generate_management_output
- name: copy ibm-provider config to the terraform dir
  template:
    src: 'provider.tf.j2'
    dest: '{{status_dir}}/terraform/provider.tf'
- name: copy variables to the terraform dir
  template:
    src: 'variables.auto.tfvars.j2'
    dest: '{{status_dir}}/terraform/variables.auto.tfvars'

- name: Run terraform init in terraform_temp
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: 'terraform init'

- name: Run terraform plan in terraform_temp 
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: bash -c "terraform plan 2>&1 >> apply.log"

- name: Run terraform apply in terraform_temp 
  shell: 
    chdir: '{{status_dir}}/terraform'
    cmd: bash -c "terraform apply -auto-approve 2>&1 >> apply.log"
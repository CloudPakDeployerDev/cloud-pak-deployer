---
# tasks file for cp4d-cluster
- debug:
    msg: "{{ current_cp4d_cluster }}"

- debug:
    msg: "Handling CP4D cluster {{ current_cp4d_cluster.name }}"

- name: Validate if IBM Container Registry {{ current_cp4d_cluster.container_registry_namespace }} exists
  shell: "ibmcloud cr namespace-list | grep -w '^{{ current_cp4d_cluster.container_registry_namespace }} ' | wc -l"
  register: ibmcloud_cr_exists_result
  failed_when: "not ibmcloud_cr_exists_result.stdout == '1'"

- name: Login to the OpenShift cluster
  include_role:
    name: login-roks-ocp
  vars:
    roks_name: "{{ current_cp4d_cluster.openshift_cluster_name }}"

- name: Prepare OpenShift project {{ current_cp4d_cluster.project }}
  include_role:
    name: prepare-project

- name: Check for cp4d service definitions, skip when empty
  debug:
    msg: "OpenShift Project {{ current_cp4d_cluster.cp4d_cluster_name }} from ROKS cluster {{ current_cp4d_cluster.roks_name }} on VPC {{ vpc.vpc_name }} has no cp4d_services definitions. No installation will be performed..."
  when: current_cp4d_cluster.cp4d_services|length == 0

- name: Loop through each available service and uninstall service not included in cp4d_services for OpenShift project {{ current_cp4d_cluster.project }}
  include_role:
    name: cp4d-service-uninstall
  loop: "{{ all_cp4d_services }}"
  loop_control:
    loop_var: cp4d_service

- name: Loop through each cp4d_service of the OpenShift Project {{ current_cp4d_cluster.project }} from ROKS cluster {{ current_cp4d_cluster.roks_name }}
  include_role:
    name: cp4d-service
  loop: "{{ range(0,9)|list }}"
  loop_control:
    loop_var: service_number

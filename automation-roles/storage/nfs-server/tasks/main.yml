---

- name: Validate mandatory variables are defined
  assert:
    that:
      - cloud_platform is defined

- name: Validate cloud_platform is implemented
  fail: msg="cloud_platform {{ cloud_platform }} is not implemented, current implemented cloud platforms are {{ implemented_cloud_platform_types }} "
  when: "cloud_platform not in implemented_cloud_platform_types"

- set_fact:
    storage_type: "{{ roks_config.roks[0].storage_classes[0].storage_type }}"

- block:
  - set_fact:
      nfs_server_name: "{{ roks_config.roks[0].storage_classes[0].nfs_server_name }}"

  - set_fact:
      nfs_server: "{{ servers_config.nfs_servers | json_query(query) | first }}"
    vars:
      query: >-
          [?name=='{{nfs_server_name}}']

  # TODO - Is infrastructure type correct for the IBM Cloud File service?
  - name: Configure NFS server IBM Cloud SaaS
    block:
      - name: Configure NFS server for IBM Cloud SaaS
        include_role: 
          name: nfs-server-ibmcloud-saas
    when: cloud_platform == 'ibm-cloud' and nfs_server.infrastructure.type == 'saas'

  - name: Configure NFS server IBM Cloud VPC
    block:
      - name: Configure NFS server for IBM Cloud VPC
        include_role: 
          name: nfs-server-ibmcloud-vpc-prepare
    when: cloud_platform == 'ibm-cloud' and nfs_server.infrastructure.type == 'vpc'
  when: storage_type == 'nfs'
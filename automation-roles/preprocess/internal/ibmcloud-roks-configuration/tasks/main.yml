---
- name: Validate mandatory variables are defined
  assert:
    that:
      - current_roks_cluster is defined

- include_vars:
    file: "files/worker_flavour.yaml"
    name: worker_flavours

- include_vars:
    file: "files/worker_count.yaml"
    name: worker_count

- name: Get the worker flavour
  set_fact:
    worker_flavour_implementation_query: "{{ worker_flavours.worker_flavour | json_query(workerquery) }} "
  vars: 
    workerquery: "[? size=='{{ current_roks_cluster.worker_flavour }}'].implementation"

#- set_fact:
#    current_roks_cluster2: "{{ current_roks_cluster | combine({'worker_flavour':worker_flavour_implementation_query[0]}) }}"

- set_fact:
    current_roks_cluster_worker_flavour: "{{ worker_flavour_implementation_query.0 }}"
- set_fact:
     current_roks_cluster_worker_count: "{{ current_roks_cluster.worker_count | default(worker_count.worker_count_min_default) }}"
- set_fact:
     current_roks_cluster_worker_count_int: "{{ current_roks_cluster_worker_count | int }}"

- name: Validate worker count minimum threshold is met
  fail: msg="Minimum worker count must be {{ worker_count.worker_count_min_threshold }}. Currently set at {{ current_roks_cluster_worker_count }}"
  when: "current_roks_cluster_worker_count_int < worker_count.worker_count_min_threshold"





- debug:
    msg: "Worker Flavour: {{ current_roks_cluster_worker_flavour }}"
- debug:
    msg: "Number of workers: {{ current_roks_cluster_worker_count }}"











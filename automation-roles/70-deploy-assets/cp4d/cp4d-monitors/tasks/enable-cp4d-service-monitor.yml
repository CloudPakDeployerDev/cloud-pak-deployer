---

- name: Validate the Cluster Monitor is already configured
  shell: |
    oc get cm -n openshift-monitoring --no-headers | grep cluster-monitoring-config | wc -l
  register: _cluster_monitor_config_exists
    
- when: _cluster_monitor_config_exists.stdout == "0"
  block:

    - name: Create cluster monitor configuration file
      template:
        src: enable-openshift-monitoring.j2
        dest: "{{ _cloud_pak_service_monitor_dir.path }}/cluster-monitor-config.yaml"
    
    - name: Create cluster monitor configuration
      shell: |
        oc create -f {{ _cloud_pak_service_monitor_dir.path }}/cluster-monitor-config.yaml
    
    - name: Wait 15 seconds
      pause:
        seconds: 15

    - name: Wait until openshift-user-workload-monitoring pods are ready
      shell: oc -n openshift-user-workload-monitoring get pods --no-headers | grep "Running" | wc -l
      register: _openshift_user_workload_pod
      retries: 20
      delay: 10
      until:
        - _openshift_user_workload_pod.rc==0
        - _openshift_user_workload_pod.stdout=='5'

- name: Validate Cloud Pak for Data ServiceMonitor is configured
  shell: |
    oc get ServiceMonitor -n {{ current_cp4d_cluster.project }} --no-headers | grep zen-watchdog | wc -l
  register: _cp4d_servicemonitor_exists

- when: _cp4d_servicemonitor_exists.stdout == "0"
  block:

    - name: Create Cloud Pak for Data ServiceMonitor for project {{ current_cp4d_cluster.project }}
      template:
        src: cp4d-service-monitor.j2
        dest: "{{ _cloud_pak_service_monitor_dir.path }}/cp4d-service-monitor-config.yaml"
    
    - name: Create Cloud Pak for Data ServiceMonitor
      shell: |
        oc create -f "{{ _cloud_pak_service_monitor_dir.path }}/cp4d-service-monitor-config.yaml"
---
- name: Validate mandatory variables are defined
  assert:
    that:
      - cloud_platform is defined

- name: Validate cloud_platform is implemented
  fail: msg="cloud_platform {{ cloud_platform }} is not implemented, current implemented cloud platforms are {{ implemented_cloud_platform_types }} "
  when: "cloud_platform not in implemented_cloud_platform_types"

- name: Download ROSA command line tool 
  include_role:
    name: aws-download-rosa

- name: Login to ROSA
  include_role:
    name: aws-login-rosa

- name: Get aws-access-key secret from in the vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "aws-access-key"
    secret_group: "{{ environment_name }}" 

- set_fact:
    _aws_access_key: "{{ secret_value }}"

- name: Get aws-secret-access-key secret from the vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "aws-secret-access-key"
    secret_group: "{{ environment_name }}" 

- set_fact:
    _aws_secret_access_key: "{{ secret_value }}"

- name: Check if ROSA cluster already exists
  shell: |
    rosa describe cluster \
      --cluster {{ _current_openshift_cluster.name }} \
      --region {{ _current_openshift_cluster.infrastructure.aws_region }}
  environment:
    AWS_ACCESS_KEY_ID: "{{ _aws_access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ _aws_secret_access_key }}"
  register: _aws_describe_cluster
  failed_when: False
    
- name: Create ROSA cluster
  shell: |
    rosa create cluster --cluster-name {{ _current_openshift_cluster.name }} \
      --version {{ _current_openshift_cluster.ocp_version }} \
      --multi-az \
      --region {{ _current_openshift_cluster.infrastructure.aws_region }} \
      --compute-machine-type {{ _current_openshift_cluster.worker_flavour }} \
      --compute-nodes {{ _current_openshift_cluster.number_of_workers }}
  environment:
    AWS_ACCESS_KEY_ID: "{{ _aws_access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ _aws_secret_access_key }}"
  when: _aws_describe_cluster.rc != 0

- name: Wait until cluster {{ _current_openshift_cluster.name }} is ready
  shell: |
    rosa describe cluster \
      --cluster {{ _current_openshift_cluster.name }} \
      --region {{ _current_openshift_cluster.infrastructure.aws_region }} \
      -o json
  environment:
    AWS_ACCESS_KEY_ID: "{{ _aws_access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ _aws_secret_access_key }}"
  register: _aws_describe_cluster
  until: ((_aws_describe_cluster.stdout | from_json).state | default("") | lower) == 'ready'
  delay: 60
  retries: 120

- name: Check if cluster-admin user already defined for cluster {{ _current_openshift_cluster.name }}
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _current_openshift_cluster.name }}-cluster-admin-password"
    secret_group: "{{ environment_name }}" 

- block:
  - name: Create admin user for cluster {{ _current_openshift_cluster.name }}
    shell: |
      rosa create admin \
        --cluster {{ _current_openshift_cluster.name }} \
        --region {{ _current_openshift_cluster.infrastructure.aws_region }}
    register: _create_cluster_admin
    environment:
      AWS_ACCESS_KEY_ID: "{{ _aws_access_key }}"
      AWS_SECRET_ACCESS_KEY: "{{ _aws_secret_access_key }}"

  - name: Show ROSA create admin result
    debug:
      var: _create_cluster_admin

  - set_fact:
      _cluster_admin_password: "{{ _create_cluster_admin.stdout | regex_search('--password[ ](.*)','\\1') | first }}"

  - name: Show ROSA cluster-admin password
    debug:
      var: _cluster_admin_password

  - name: Store cluster-admin password
    include_role:
      name: vault-create-secret
    vars:
      secret_name: "{{ _current_openshift_cluster.name }}-cluster-admin-password"
      secret_description: "ROSA cluster-admin password for cluster {{ _current_openshift_cluster.name }}"
      secret_payload: "{{ _cluster_admin_password }}"
      secret_group: "{{ environment_name }}"

  when: secret_value == ""
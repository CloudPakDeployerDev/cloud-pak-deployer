#Check if the current cluster has a pwx storage_type
#- set_fact:
#    _pwx_storage: "{{ current_openshift_cluster | json_query(pwx_query) }}"
#  vars:
#    pwx_query: "openshift.openshift_storage[?storage_name.storage_type=='pwx']"

#- debug:
#    msg: "{{_pwx_storage}}"


#Retrieve all the workers, and call a task to delete the pwx storage attachments (if present)
- name: Verify cluster exists    
  command: |
    ibmcloud oc cluster get --cluster {{ current_openshift_cluster.name }} \
      --output json
  register: _clustercheck
  failed_when: false

- name: Get workers and loop for pwx block storage
  block:
    - name: Get workers    
      command: |
        ibmcloud oc workers --cluster {{ current_openshift_cluster.name }} \
          --worker-pool default --output json
      register: _default_workers
      
    - name: Loop workers     
      include_tasks: delete_storage_attachment_pwx.yaml
      loop: "{{ _default_workers.stdout | from_json }}"
      loop_control:
        loop_var: current_worker
  when: _clustercheck.rc==0
  
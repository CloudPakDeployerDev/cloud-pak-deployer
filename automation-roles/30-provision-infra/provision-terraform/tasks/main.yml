---
- name: Validate mandatory variables are defined
  assert:
    that:
      - cloud_platform is defined

- name: Validate cloud_platform is implemented
  fail: msg="cloud_platform {{ cloud_platform }} is not implemented, current implemented cloud platforms are {{ implemented_cloud_platform_types }} "
  when: "cloud_platform not in implemented_cloud_platform_types"

# TODO: Reinstate ROKS Classic
# - name: OpenShift Terraform for IBM Cloud
#   block:
#     - name: Provision OpenShift on IBM Cloud Classic Infrastructure
#       include_role: 
#         name: ibmcloud-terraform-classic
#       when: all_config.roks[0].infrastructure.type == "classic"
#   when: "cloud_platform == 'ibm-cloud'"

- name: Provision IBM Cloud VPC Infrastructure
  block:

  - name: Generate or retrieve the SSH keys
    include: ibmcloud-vpc-ssh.yaml
    loop: "{{ all_config.ssh_keys }}"

  - name: "Include 'generators'-role and pass variables to it"
    include_role:
      name: generators
    vars:
      path_to_config_folder: "{{ config_dir }}/generator_config"
      path_to_definitions_folder: "{{ config_dir }}/config"
      path_to_terraform_folder: "{{status_dir}}/terraform"

  - name: "Copy variables to Terraform directory {{status_dir}}/terraform"
    template:
      src: 'variables.auto.tfvars.j2'
      dest: '{{status_dir}}/terraform/variables.auto.tfvars'

  - name: Retrieve Terraform tfstate from the vault
    include_role: 
      name: vault-get-secret
    vars:
      secret_name: "{{ environment_name }}-terraform-tfstate"
      secret_group: "{{ environment_name }}"

  - name: Write {{ status_dir }}/terraform/terraform.tfstate file
    copy:
      content: "{{ secret_value }}"
      dest: "{{ status_dir }}/terraform/terraform.tfstate"
    when: "secret_value | trim | length > 0"

  - name: "Run terraform init in Terraform directory {{status_dir}}/terraform"
    shell: 
      chdir: '{{status_dir}}/terraform'
      cmd: 'terraform init'

  - name: "Run terraform plan in Terraform directory {{status_dir}}/terraform, check {{status_dir}}/terraform/plan.log"
    shell: 
      chdir: '{{status_dir}}/terraform'
      cmd: bash -c "terraform plan -no-color 2>&1 >> plan.log"

  - name: "Run terraform apply in Terraform directory {{status_dir}}/terraform, check {{status_dir}}/terraform/apply.log"
    shell: 
      chdir: '{{status_dir}}/terraform'
      cmd: bash -c "terraform apply -auto-approve -no-color 2>&1 >> apply.log"
    environment:
      TF_LOG: "info"
      TF_LOG_PATH: "{{ status_dir }}/terraform/tf_apply.log"
    register: terraform_apply
    ignore_errors: yes

  - debug:
      var: terraform_apply

  - set_fact:
      tf_state_content: "{{ lookup('file', status_dir+'/terraform/terraform.tfstate') }}"

  - name: Store the terraform tfstate file as secret {{ environment_name }}-terraform-tfstate in group {{ environment_name }}
    include_role:
      name: vault-create-secret
    vars:
      secret_name: "{{ environment_name }}-terraform-tfstate"
      secret_group: "{{ environment_name }}"
      secret_payload: "{{ tf_state_content }}"
    when: "tf_state_content | length > 0"

  - fail:
      msg: Error occurred during Terraform apply, state has been preserved. Failing now. Check the apply log for details.
    when: terraform_apply.rc!=0

  when: "cloud_platform == 'ibm-cloud'"



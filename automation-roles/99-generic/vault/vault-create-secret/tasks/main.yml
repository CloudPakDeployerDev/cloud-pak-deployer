- name: Validate mandatory variables are defined
  assert:
    that:
      - secret_name is defined
      - secret_group is defined

- name: Validate secret payload is defined if no file specified
  assert:
    that:
      - secret_payload is defined
  when: secret_file | default("") == ''

- name: Get secret from secret file if it was specified
  set_fact:
    secret_value: "{{ lookup('file', secret_file) }}"
  when: secret_file | default("") != ''

- name: Set secret value from payload if no file specified
  set_fact:
    secret_value: "{{ secret_payload }}"
  when: secret_file | default("") == ''

- debug:
    var: secret_value

- name: Create Secret Vault Hashicorp
  block:
    - name: Validate mandatory variables are defined for Hashicorp Vault
      assert:
        that:
          - vault_secret_path is defined
          - vault_secret_field is defined

    - name: Create Secret Hashicorp vault (API Key)
      include_tasks: create-secret-hashicorp-api-key.yml
      vars:
        hashicorp_vault_address: "{{ vault_url }}"
        hashicorp_vault_login_token: "{{ vault_api_key }}"
        hashicorp_secret_name_path: "{{ vault_secret_path }}/{{ secret_group}}/{{ secret_name }}"
        hashicorp_secret_field: "{{ vault_secret_field }}"
        hashicorp_secret_payload: "{{ secret_value | b64encode }}"
      when: vault_authentication_type == 'api-key'

    - name: Get Secret Hashicorp vault (Certificate)
      include_tasks: create-secret-hashicorp-certificate.yml
      vars:
        hashicorp_vault_address: "{{ vault_url }}"
        hashicorp_vault_ca_certificate: "{{ vault_ca_cert }}"
        hashicorp_vault_client_certificate: "{{ vault_client_cert}}"
        hashicorp_vault_client_key: "{{ vault_client_key }}"
        hashicorp_secret_name_path: "{{ vault_secret_path }}/{{ secret_group}}/{{ secret_name }}"
        hashicorp_secret_field: "{{ vault_secret_field }}"
        hashicorp_secret_payload: "{{ secret_value | b64encode }}"
      when: vault_authentication_type == 'certificate'      
  when: "vault_type == 'hashicorp-vault'"

- name: Create Secret Vault IBM Cloud
  block:
    - name: Create secret from Vault IBMCloud
      include_tasks: create-secret-ibmcloud.yml
      vars:
        ibmcloud_vault_address: "{{ vault_url }}"
        ibm_cloud_secret_name: "{{ secret_name }}"
        ibm_vault_secret_payload: "{{ secret_value | b64encode }}"
  when: "vault_type == 'ibmcloud-vault'"

- name: Create Secret Vault file
  block:
    - name: Set secret in Vault file
      include_tasks: create-secret-file.yml
      vars:
        file_secret_payload: "{{ secret_value | b64encode }}"
  when: "vault_type == 'file-vault'"
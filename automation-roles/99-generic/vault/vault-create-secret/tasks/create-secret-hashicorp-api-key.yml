---
- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - hashicorp_vault_address is defined
      - hashicorp_secret_name_path is defined
      - hashicorp_secret_field is defined

- name: Create the new secret inside vault
  shell: |
    vault kv put \
      -address={{ hashicorp_vault_address }} \ 
      {{ hashicorp_secret_name_path }} \
      {{ hashicorp_secret_field }}='{{ hashicorp_secret_payload }}'
  register: hashicorp_vault_create_result

- name: Set secret inside vault via value
  block:
  - name: Set secret value in plain text
    shell: |
      vault kv put \
        -address={{ hashicorp_vault_address }} \ 
        {{ hashicorp_secret_name_path }} \
        {{ hashicorp_secret_field }}={{ hashicorp_secret_payload }}
    register: hashicorp_vault_create_result
    when: not (vault_secret_base64 | default(True))

  - name: Set secret value in base64 encoding
    shell: |
      vault kv put \
        -address={{ hashicorp_vault_address }} \ 
        {{ hashicorp_secret_name_path }} \
        {{ hashicorp_secret_field }}={{ hashicorp_secret_payload | b64encode }}
    register: hashicorp_vault_create_result
    when: (vault_secret_base64 | default(True))
  when: (hashicorp_secret_file | default("") == "")

- name: Set secret value via file in plain text
  shell: |
    vault kv put \
      -address={{ hashicorp_vault_address }} \ 
      {{ hashicorp_secret_name_path }} \
      {{ hashicorp_secret_field }}=@{{ hashicorp_secret_file }}
  register: hashicorp_vault_create_result
  when: 
    - not (vault_secret_base64 | default(True))
    - (hashicorp_secret_file | default("") != "")

- name: Set th secret inside vault via file in base64
  block: 
  - name: Create temporary file for base64 content
    tempfile:
      state: file
    register: _vault_secret_base64_file

  - name: Write secret in base64 to temporary file
    shell: |
      cat {{ hashicorp_secret_file }} | base64 -w 0 > {{ _vault_secret_base64_file.path }}

  - name: Set secret value via file in base64
    shell: |
      vault kv put \
        -address={{ hashicorp_vault_address }} \ 
        {{ hashicorp_secret_name_path }} \
        {{ hashicorp_secret_field }}=@{{ _vault_secret_base64_file.path }}
    register: hashicorp_vault_create_result

  when: 
    - (hashicorp_secret_file | default("") != "")
    - (vault_secret_base64 | default(True))

- debug:
    msg: "Secret {{ hashicorp_secret_name_path }} field {{ hashicorp_secret_field }} successfully created on Hashicorp vault"
---
- name: Get secret Validate mandatory variables are defined
  assert:
    that:
      - secret_group is defined
      - secret_name is defined

- name: Check that vault file {{ secret_group }} exists
  stat:
    path: "{{ status_dir }}/vault/{{ secret_group }}"
  register: vault_file_details

- set_fact:
    secret_value: ""

- set_fact:
    _secret_value_b64: "{{ lookup('ini', secret_name + ' type=properties file=' + status_dir + '/vault/' + secret_group) }}"
  when: vault_file_details.stat.exists

- set_fact:
    secret_value: "{{ _secret_value_b64 | b64decode }}"

- name: Write secret to file {{ secret_file }} if one was specified
  shell: |
    echo "{{ _secret_value_b64 }}" | base64 -d > "{{ secret_file }}"
  when: 
  - secret_file | default("") != ''
  - secret_value != ''

- name: Write empty value to file {{ secret_file }} if secret was not found
  shell: |
    echo "" > "{{ secret_file }}"
  when: 
  - secret_file | default("") != ''
  - secret_value == ''


---
- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - hashicorp_vault_address is defined
      - VAULT_CERT_CA_FILE is defined
      - VAULT_CERT_KEY_FILE is defined
      - VAULT_CERT_CERT_FILE is defined
      - hashicorp_secret_name_path is defined
      - hashicorp_secret_field is defined

- name: Get the secret id if the secret exists
  include_role:
    name: vault-has-secret

- name: Get secret value
  block:
    - name: Get the secret value
      shell: |
        vault kv get \
          -ca-cert={{ VAULT_CERT_CA_FILE }} \
          -client-cert={{ VAULT_CERT_CERT_FILE }} \
          -client-key={{ VAULT_CERT_KEY_FILE }} \
          -address={{ hashicorp_vault_address }} \ 
          -field={{ hashicorp_secret_field }} \
          {{ hashicorp_secret_name_path }}
      register: hashicorp_vault_get_secret_result

    - set_fact:
        secret_value: "{{ hashicorp_vault_get_secret_result.stdout | b64decode }}"
      when: (vault_secret_base64 | default(True))

    - set_fact:
        secret_value: "{{ hashicorp_vault_get_secret_result.stdout }}"
      when: not (vault_secret_base64 | default(True))
  when: has_secret == true

- set_fact:
    secret_value: ""
  when: has_secret == false

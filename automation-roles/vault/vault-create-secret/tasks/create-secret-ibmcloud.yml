---
- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - ibm_cloud_secret_group is defined
      - ibm_cloud_secret_name is defined
      - ibmcloud_vault_address is defined
      - ibm_vault_token_content is defined    
      - ibm_vault_secret_payload is defined

- name: Get the Cloud vault group id
  include_role: 
     name: vault-group

- name: Validate if the secret already exists
  include_role: 
     name: has-secret-ibmcloud

- name: Delete secret {{ ibm_cloud_secret_name }} in group {{ ibm_cloud_secret_group_id }} if it already exists
  include_role:
    name: delete-secret-ibmcloud
  when: "has_secret == true"

- name: Create new secret {{ secret_name }} in group {{ secret_group }}
  uri:
    url: "{{ ibmcloud_vault_address }}/v1/ibmcloud/arbitrary/secrets/groups/{{ secret_group_id }}"
    headers:
      X-Vault-Token: "{{ ibm_vault_token_content.auth.client_token }}"
      Accept: "application/json"
      Content-Type: "application/json"    
    method: POST
    body_format: json
    body:
      name: "{{ ibm_cloud_secret_name }}"
      payload: "{{ ibm_vault_secret_payload }}"
    status_code: 200
  register: response_createSecret

- debug:
    msg: "Secret {{ secret_name }} successfully created on IBMCloud vault"
---
- name: Has secret Validate mandatory variables are defined
  assert:
    that:
      - hashicorp_vault_address is defined
      - hashicorp_secret_name_path is defined
      - hashicorp_secret_field is defined

- name: Validate if secret is available
  shell: |
    vault kv get \
      -address={{ hashicorp_vault_address }} \ 
      -field={{ hashicorp_secret_field }} \
      {{ hashicorp_secret_name_path }}
  ignore_errors: yes
  register: hashicorp_vault_get_secret_result

- set_fact:
    has_secret: true
  when: "hashicorp_vault_get_secret_result.rc == 0"

- set_fact:
    has_secret: false
  when: "not hashicorp_vault_get_secret_result.rc == 0"

- debug:
    msg: "Secret {{ secret_name_path }} lookup resulted in {{ has_secret }}"
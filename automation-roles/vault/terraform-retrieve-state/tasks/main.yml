---
# tasks file for terraform-retrieve-state
- set_fact:
    tf_state_secret_name: "{{ roks_name }}-terraform-tfstate"

- name: Validate if existing terraform state files exist in the vault
  include_role:
    name: vault-get-secret
  vars:
    secret_name: "{{ tf_state_secret_name }}"
    secret_group: "{{ roks_name }}" 

- name: When the terraform state file exist, decode and write to disk
  block:

    - name: Create temporary terraform directory if it does not exist
      file:
        path: "{{status_dir}}/terraform"
        state: directory

    - copy:
        content: "{{ secret_value | b64decode }}"
        dest: "{{ status_dir }}/terraform/terraform.tfstate"
      when: "secret_value|length > 0"

  when: "not secret_value == ''"

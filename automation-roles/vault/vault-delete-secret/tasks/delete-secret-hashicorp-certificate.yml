---
- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - hashicorp_vault_address is defined
      - hashicorp_vault_ca_certificate is defined
      - hashicorp_vault_client_certificate is defined
      - hashicorp_vault_client_key is defined
      - hashicorp_secret_name_path is defined
      - hashicorp_secret_field is defined

- name: Get the secret value
  shell: |
    vault kv get \
      -ca-cert={{ hashicorp_vault_ca_certificate }} \
      -client-cert={{ hashicorp_vault_client_certificate }} \
      -client-key={{ hashicorp_vault_client_key }} \
      -address={{ hashicorp_vault_address }} \ 
      -field={{ hashicorp_secret_field }} \
      {{ secret_name_path }}
  register: hashicorp_vault_get_secret_result

- set_fact:
    secret_value: "{{ hashicorp_vault_get_secret_result.stdout | b64decode }}"

- debug:
    msg: "Secret {{ secret_name_path }} value {{ secret_value }}"
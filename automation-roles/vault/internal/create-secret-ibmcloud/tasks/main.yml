---

- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - secret_group is defined
      - secret_name is defined
      - secret_payload is defined
      - secret_description is defined
      - ibmcloud_vault_address is defined
      - ibm_vault_token_content

- name: Get or Create the IBMVault Group ID
  include_role: 
     name: get-or-create-secret-group-ibmcloud

- name: Create the new secret inside vault in group {{ secret_group }}
  uri:
    url: "{{ ibmcloud_vault_address }}/v1/ibmcloud/arbitrary/secrets/groups/{{ secret_group_id }}"
    headers:
      X-Vault-Token: "{{ ibm_vault_token_content.auth.client_token }}"
      Accept: "application/json"
      Content-Type: "application/json"    
    method: POST
    body_format: json
    body:
      metadata:
        collection_type: "application/vnd.ibm.secrets-manager.secret+json"
        collection_total: 1
      resources:
        - name: "{{ secret_name }}"
          description: "{{ secret_description }}"
          payload: "{{ secret_payload }}"
    status_code: 200
  register: response_createSecret

#- debug:
#    msg: "Secret {{ secret_name }} successfully created on IBMCloud vault"
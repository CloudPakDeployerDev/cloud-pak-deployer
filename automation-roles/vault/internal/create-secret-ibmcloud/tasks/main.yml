---

- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - secret_group is defined
      - secret_name is defined
      - secret_payload is defined
      - secret_description is defined
      - ibmcloud_vault_address is defined
      - ibm_vault_token_content is defined

- name: Validate if the secret already exists
  include_role: 
     name: has-secret-ibmcloud

- name: Delete secret {{ secret_name }} in group {{ secret_group }} if it already exists
  include_role:
    name: delete-secret-ibmcloud
  when: "has_secret == true"

# TODO: Fail if new secret could not be created
- name: Create new secret {{ secret_name }} in group {{ secret_group }}
  uri:
    url: "{{ ibmcloud_vault_address }}/v1/ibmcloud/arbitrary/secrets/groups/{{ secret_group_id }}"
    headers:
      X-Vault-Token: "{{ ibm_vault_token_content.auth.client_token }}"
      Accept: "application/json"
      Content-Type: "application/json"    
    method: POST
    body_format: json
    body:
      name: "{{ secret_name }}"
      description: "{{ secret_description }}"
      payload: "{{ secret_payload }}"
    status_code: 200
  register: response_createSecret
  

- debug:
    msg: "Secret {{ secret_name }} successfully created on IBMCloud vault"
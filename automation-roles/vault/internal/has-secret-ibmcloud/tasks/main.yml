---

- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - secret_name is defined
      - ibmcloud_vault_address is defined
      - ibm_vault_iam_token is defined


- name: Validate if the secret {{ secret_name }} is available
  uri:
    url: "{{ ibmcloud_vault_address }}/api/v1/secrets"
    headers:
      Authorization: "Bearer {{ ibm_vault_iam_token.json.access_token }}"
      Accept: "application/json"
    status_code: 200
  register: response_getSecret


- debug:
    msg: "{{ response_getSecret.json.resources | from_json }}"

- set_fact:
    response_getSecret_json: "{{ response_getSecret.json | from_json }}"

- set_fact:
    response_getSecret_json_result: "{{ response_getSecret_json.resources|json_query(query_secret) }}"
  vars:
    query_secret: "[?name=='{{ secret_name }}']"

- set_fact:
    has_secret: "not response_getSecret_json_result.length == 0"

- debug:
    msg: "Contains secret: {{ has_secret }}"
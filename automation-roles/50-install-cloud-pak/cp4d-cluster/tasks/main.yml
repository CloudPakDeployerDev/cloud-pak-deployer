---
# tasks file for cp4d-cluster
- debug:
    msg: "Handling CP4D cluster {{ current_cp4d_cluster.project }}"

- name: Prepare OpenShift cluster for Cloud Pak for Data
  include_role:
    name: cp4d-prepare-openshift

- name: Prepare cpd-cli if Cloud Pak for Data 3.5
  include_tasks: cpd-cli-cp4d-35.yml
  when: current_cp4d_cluster.cp4d_version | default('3.5') == '3.5'

- name: Login to the OpenShift cluster
  include_role:
    name: openshift-login
  vars:
    roks_name: "{{ current_cp4d_cluster.openshift_cluster_name }}"

- name: Prepare OpenShift project {{ current_cp4d_cluster.project }} for Cloud Pak for Data
  include_role:
    name: openshift-prepare-project

# - name: Check for cp4d service definitions, skip when empty
#   debug:
#     msg: "OpenShift Project {{ current_cp4d_cluster.project }} from ROKS cluster {{ current_cp4d_cluster.roks_name }} on VPC {{ vpc.vpc_name }} has no cp4d_services definitions. No installation will be performed..."
#   when: current_cp4d_cluster.cp4d_services|length == 0

# - name: Loop through each available service and uninstall service not included in cp4d_services for OpenShift project {{ current_cp4d_cluster.project }}
#   include_role:
#     name: cp4d-service-uninstall
#   loop: "{{ all_cp4d_services }}"
#   loop_control:
#     loop_var: cp4d_service

- name: Ensure the status log folder exists
  file:
    path: "{{status_dir}}/log"
    state: directory

- name: Loop through each cp4d cartridge of the OpenShift Project {{ current_cp4d_cluster.project }} from cluster {{ current_cp4d_cluster.openshift_cluster_name }}
  include_role:
    name: cp4d-service
  loop: "{{ current_cp4d_cluster.cartridges | default([]) }}"
  loop_control:
    loop_var: current_cp4d_cartridge

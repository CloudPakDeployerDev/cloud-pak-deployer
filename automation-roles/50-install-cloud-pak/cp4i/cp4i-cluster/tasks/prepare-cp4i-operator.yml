---

# -------------------------------------------------------------------------------
# TODO(SJ): Create operator group in case of installation in a specific namespace
# Ref: ''CP4I-install-CLI
# -------------------------------------------------------------------------------
# apiVersion: operators.coreos.com/v1
# kind: OperatorGroup
# metadata:
#   name: ibm-integration-operatorgroup
#   namespace: cp4i
# spec:
#   targetNamespaces:
#   - cp4i  



- name: Prepare yaml file for installing operators
  template:
    src: cp4i-operators-all-projects.j2
    dest: "{{ status_dir }}/cp4i/cp4i-operators-all-projects.yml"

- name: Install operators from {{ status_dir }}/cp4di/cp4i-operators-all-projects.yml
  shell: |
    oc apply -f {{ status_dir }}/cp4i/cp4i-operators-all-projects.yml

- name: Set Platform Navigator subscription details - online
  block:
    - set_fact:
        pn_package: "{{platform_navigator_package_name_online}}"
    - set_fact:
        pn_source: "{{platform_navigator_catalog_source_online}}"
  when: not _use_case_files

- name: Set Platform Navigator subscription details - CASE
  block:
    - set_fact:
        pn_package: "{{platform_navigator_package_name_case}}"
    - set_fact:
        pn_source: "{{platform_navigator_catalog_source_case}}"
  when: _use_case_files

- name: Wait for the Platform Navigator Operator subscription
  shell: |
    subscription_name="{{pn_package}}-{{current_cp4i_cluster.platform_navigator.channel}}-{{pn_source}}-openshift-marketplace"
    csv=$(oc get subscription -n openshift-operators ${subscription_name} -o json | jq -r .status.currentCSV)
    if [[ "$csv" == "null" ]]; then
      echo "null"
    else
      oc get csv -n openshift-operators ${csv} -o json 2>/dev/null | jq -r .status.phase
    fi
  register: pn_phase
  retries: 100
  delay: 20
  until: pn_phase.stdout == "Succeeded"


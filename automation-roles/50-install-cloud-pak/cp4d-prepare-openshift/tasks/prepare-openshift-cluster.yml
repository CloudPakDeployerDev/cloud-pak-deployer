# tasks file for roks-cluster
---

- name: Make a temporary work folder available
  tempfile:
    state: directory
  register: cp4d_automation_temp_dir

- name: Login to the OpenShift cluster
  include_role:
    name: ibmcloud-login-roks-ocp
  vars: 
    roks_name: "{{ current_cp4d_cluster.openshift_cluster_name }}"

- name: Check if the Tuned cp4d-ipc is available
  shell: "oc get Tuned -n openshift-cluster-node-tuning-operator | grep -i '^cp4d-ipc' | wc -l"
  register: oc_tuned_exists

- name: Configure Tuned cp4d_ipc
  block:
    - name: Create Tuned yaml
      template:
        src: cp4d-tuned.j2
        dest: "{{ cp4d_automation_temp_dir.path }}/cp4d-tuned.yaml"
    - name: Create Tuned cp4d_ipc
      shell: "oc apply -f {{ cp4d_automation_temp_dir.path }}/cp4d-tuned.yaml"
  when: oc_tuned_exists.stdout == "0"

- name: Check if ImageContentSourcePolicy exists for CP4D 4.0
  block:
    - name: Create ImageContentSourcePolicy yaml
      template:
        src: cp4d-icsp.j2
        dest: "{{ cp4d_automation_temp_dir.path }}/cp4d-icsp.yaml"
    - name: Create ImageContentSourcePolicy cp4d_ipc
      shell: "oc apply -f {{ cp4d_automation_temp_dir.path }}/cp4d-icsp.yaml"  
  when: current_cp4d_cluster.cp4d_version | default('3.5') != '3.5'

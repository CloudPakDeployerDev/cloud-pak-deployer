---
- block:
  - name: Generate OLM utils command to create cartridge subscription
    set_fact:
      _apply_olm_command: "{{ lookup('template', 'apply-olm-one-cartridge-sub.j2') }}" 
    vars:
      _p_preview_script: False

  - name: Show apply-olm command to create cartridge subscription
    debug:
      var: _apply_olm_command

  - name: Run apply-olm command to install subscription {{ _current_cartridge.name }}, logs are in {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-apply-olm-cartridge-sub.log
    shell: |
      {{ _apply_olm_command }} >> {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-apply-olm-cartridge-sub.log 2>&1
    failed_when: False
    register: _apply_olm_result

  - name: Show subscriptions state if apply-olm failed
    block:
    - name: Retrieving state of all operators in project {{ foundational_services_project }}
      shell: |
        oc get sub -n {{ foundational_services_project }} \
          --no-headers \
          --sort-by=.metadata.creationTimestamp \
          -o jsonpath='{range .items[*]}{.metadata.name}{","}{.metadata.creationTimestamp}{","}{.status.installedCSV}{","}{.status.state}{"\n"}{end}' 
      register: _subscription_state
    - fail:
        msg: "{{ _subscription_state.stdout_lines }}"
    when: _apply_olm_result.rc != 0
  when: (_current_cartridge.state | default('installed'))=='installed'
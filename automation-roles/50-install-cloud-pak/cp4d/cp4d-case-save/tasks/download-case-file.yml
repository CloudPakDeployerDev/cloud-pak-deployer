---

# Find the latest version
# curl -s -X GET https://api.github.com/repos/IBM/cloud-pak/contents/repo/case/ibm-cp-datacore | jq -r '.[] | select(.name|test("^[0-9].*")) | .name'

# Download case file is state is installed
- block:
  - name: Fail if the case file details for the cartridge cannot be found
    fail:
      msg: Case file details for cartridge {{ _current_cp4d_cartridge.name }} not found
    when: (_current_cp4d_cartridge.search_string | default(""))==""

  - set_fact:
      _dependency: ""

  - set_fact:
      _dependency: "--no-dependency"
    when:  
    - _current_cp4d_cartridge.name in ['cpd_platform','lite']

  - name: Save case file {{ _current_cp4d_cartridge.search_string }}-{{ _current_cp4d_cartridge.case_version }}
    shell: |
      cloudctl case save \
        --repo {{ case_github_url }} \
        --case {{ _current_cp4d_cartridge.search_string }} \
        --version {{ _current_cp4d_cartridge.case_version }} \
        --outputdir {{ _case_dir }} {{ _dependency }}
    register: _case_save
    retries: 5
    delay: 5
    until: _case_save.rc==0

  - name: Check component_dependencies case files
    include_tasks: validate-cartridge-dependency.yml
    loop: "{{ _current_cp4d_cartridge.component_dependencies | default([]) }}"
    loop_control:
      loop_var: _current_cartridge_dependent_component
    when: 
      - _current_cp4d_cartridge.component_dependencies is defined

  when: (_current_cp4d_cartridge.state | default('installed')) == 'installed' or (cpd_test_cartridges | default(False) | bool) 

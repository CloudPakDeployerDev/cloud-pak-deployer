---
- name: Acquire PostgreSQL license key from vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _edb_postgresql_secret_name }}"
    secret_group: "{{ environment_name }}" 

- fail:
    msg: "Unable to locate secret {{ _edb_postgresql_secret_name }} from the vault. Ensure this secret is populated, and rerun the Deployer"
  when: secret_value == ""

- set_fact:
    _edb_license_key: "{{ secret_value | b64encode }}"

- name: Create PostgreSQL license secret object
  template:
    src: "postgresql-license-secret.j2"
    dest: "{{ status_dir }}/cp4d/postgresql-secret.yml"

- name: Apply PostgreSQL secret
  command: |
    oc apply -f "{{ status_dir }}/cp4d/postgresql-secret.yml"

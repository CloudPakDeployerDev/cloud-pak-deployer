---
- block:
  - name: Create operator subscriptions
    debug:
      msg: "Creating operator subscription for CP4D cartridge {{ current_cp4d_cartridge.name }} for CP4D cluster {{ _p_current_cp4d_cluster.project }}"

  # Validate whether the subscription creation requires custom execution
  - name: Get subscription installation details for cartridge
    set_fact:
      _cartridge_details: "{{ case_inventories | json_query(jmes_query) | first }}"
    vars:
      jmes_query: "[?name == '{{ current_cp4d_cartridge.name }}']"

  # Custom preprpcessing of Subscription
  - name: "Run operator pre-processing script {{ _cartridge_details.operator_preprocessing_script }}"
    include_tasks: "{{ _cartridge_details.operator_preprocessing_script }}"
    when: (_cartridge_details.operator_preprocessing_script | default('')) != ''

  - debug:
      msg: "{{ current_cp4d_cartridge.name}} with {{ _cartridge_details }}"

  # Create of Subscription if not lite or cp-foundation
  - block:
  
      - name: Prepare and create the subscription
        include_tasks: cp4d-subscriptions-apply.yml
        when: 
          - current_cp4d_cartridge.name != "lite"
          - current_cp4d_cartridge.name != "cp-foundation"
          - not (_cartridge_details.cr_internal | default(False) | bool)

  when: (current_cp4d_cartridge.state | default('installed')) == 'installed'
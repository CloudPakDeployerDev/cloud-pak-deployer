---
- debug:
    msg: "Preparing custom resources for CP4D cartridge {{ current_cp4d_cartridge.name }} for CP4D cluster {{ current_cp4d_cluster.project }}"

#Validate whether the subscription creation requires custom execution
- name: Validate custom path for cartridge {{ current_cp4d_cartridge.name }}
  set_fact:
    cartridge_details: "{{ case_inventories | json_query(jmes_query) }}"
  vars:
    jmes_query: "[?name == '{{ current_cp4d_cartridge.name }}'] | [0]"

# Regular install of Subscription
- when: not cartridge_details.type is defined
  block:
    # Create operator subscription
    - name: Prepare yaml file for operator subscription {{ current_cp4d_cartridge.name }}
      template:
        src: "{{ current_cp4d_cartridge.name }}-sub.j2"
        dest: "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-{{ current_cp4d_cartridge.name }}-sub.yml"
      when: 
      - current_cp4d_cartridge.name != "lite"
      - current_cp4d_cartridge.name != "cp-foundation"

    - name: Create subscription for cartridge {{ current_cp4d_cartridge.name }}
      command: |
        oc apply -f "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-{{ current_cp4d_cartridge.name }}-sub.yml"
      when: 
      - current_cp4d_cartridge.name != "lite"
      - current_cp4d_cartridge.name != "cp-foundation"

    - name: Find label for cartridge {{ current_cp4d_cartridge.name }}
      set_fact:
        cartridge_csv_label: "{{ cartridge_csv | json_query(jmes_query) }}"
      vars:
        jmes_query: "[?name == '{{ current_cp4d_cartridge.name }}'].cartridge_label | [0]"
      when: 
      - current_cp4d_cartridge.name != "lite"
      - current_cp4d_cartridge.name != "cp-foundation"

    - name: Fail if the label for the cartridge cannot be found
      fail:
        msg: "Label for cartridge {{ current_cp4d_cartridge.name }} not found, cannot check if CSV is successfully installed"
      when: 
      - current_cp4d_cartridge.name != "lite"
      - current_cp4d_cartridge.name != "cp-foundation"
      - cartridge_csv_label == ""

    # Wait until subscription for cartridge has been successfully created
    - name: Wait until CSV for cartridge {{ current_cp4d_cartridge.name }}, label {{ cartridge_csv_label }} has status Succeeded
      shell: |
        oc get csv -n {{ foundational_services_project }} \
          --no-headers \
          -l {{ cartridge_csv_label }} \
          -o custom-columns='name:metadata.name,phase:status.phase' | \
          grep -i succeeded | wc -l
      register: csv_status
      retries: 30
      delay: 30
      until: csv_status.stdout != "0"
      when: 
      - current_cp4d_cartridge.name != "lite"
      - current_cp4d_cartridge.name != "cp-foundation"
      vars:
        ansible_callback_diy_runner_retry_msg: >-
          {%- set result = ansible_callback_diy.result.output -%}
          {%- set retries_left = result.retries - result.attempts -%}
          Retrying: {{ ansible_callback_diy.task.name }} ({{ retries_left }} Retries left) ...

# Custom install of Subscription
- when: 
  - cartridge_details.type is defined
  - cartridge_details.type == 'custom'
  block:

    - name: Fail if the cartridge was labelled as custom but no operator installation script was specified
      fail:
        msg: "Cartridge {{ current_cp4d_cartridge.name }} was labeled custom, but no install_operator_script was specified"
      when: 
      - not cartridge_details.install_operator_script is defined

    - name: "Get the custom playbook for cartridge {{ current_cp4d_cartridge.name }}"
      set_fact:
        custom_cartridge_operator_playbook: "{{ cartridge_details.install_operator_script }}"
    
    - name: "Run the custom playbook {{ custom_cartridge_operator_playbook }}"
      include_tasks: "{{ custom_cartridge_operator_playbook }}"

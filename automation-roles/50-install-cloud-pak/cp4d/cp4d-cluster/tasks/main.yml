---
- debug:
    msg: "Handling CP4D cluster {{ current_cp4d_cluster.project }}"

- set_fact:
    _current_openshift_cluster: "{{ all_config.openshift | json_query(query) | first | default({}) }}"
  vars:
    query: >-
      [?name=='{{ current_cp4d_cluster.openshift_cluster_name }}']

- name: Download and activate OpenShift client for version {{ _current_openshift_cluster.ocp_version }}
  include_role:
    name: openshift-download-client
  vars:
    _p_ocp_version: "{{ _current_openshift_cluster.ocp_version }}"

- name: Login to the OpenShift cluster
  include_role:
    name: openshift-login
  vars:
    openshift_cluster_name: "{{ current_cp4d_cluster.openshift_cluster_name }}"

- name: Get IBM Entitled Registry key
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "ibm_cp_entitlement_key"
    secret_group: "{{ environment_name }}"

- set_fact:
    ibm_cp_entitlement_key: "{{ secret_value }}"

- fail:
    msg: "No image registry name specified for CP4D but cannot pull from entitled registry because of missing entitlement key in vault"
  when: ibm_cp_entitlement_key == "" and (current_cp4d_cluster.image_registry_name | default("")) == ""

- set_fact:
    entitled_auth: "{{ entitled_registry_username }}:{{ ibm_cp_entitlement_key }}"
  when: ibm_cp_entitlement_key != ""

- set_fact:
    use_entitled_registry: False

- name: Use entitled registry if entitlement key available and no image registry name specified
  set_fact:
    use_entitled_registry: True
  when:
  - (current_cp4d_cluster.image_registry_name | default("")) == ""

- name: Connect to private image registry
  include_role: 
    name: connect-private-image-registry
  when:
  - (current_cp4d_cluster.image_registry_name | default("")) != ""

- name: Remove Cloud Pak for Data directory for generated files
  file:
    path: "{{ status_dir }}/cp4d"
    state: absent

- name: Create Cloud Pak for Data directory for generated files
  file:
    path: "{{ status_dir }}/cp4d"
    state: directory

- name: Prepare OpenShift cluster for Cloud Pak for Data
  include_role:
    name: cp4d-prepare-openshift

- set_fact:
    _use_case_files: False

- set_fact:
    _use_case_files: True
  when: (current_cp4d_cluster.image_registry_name | default("")) != "" or (current_cp4d_cluster.use_case_files | default(False) | bool)

- name: Prepare case files for Cloud Pak for Data when using private registry or when explicitly using case files
  include_tasks: prepare-cp4d-case-files-40.yml
  when: _use_case_files

- name: Mirror images for Cloud Pak for Data to private registry {{ current_cp4d_cluster.image_registry_name }}
  include_tasks: mirror-images-cp4d-40.yml
  when: 
  - (current_cp4d_cluster.image_registry_name | default("")) != ""
  - ibm_cp_entitlement_key != ""

- name: Create catalog sources for entitled registry when not using case files
  include: create-catalog-sources-entitled.yml
  when: not _use_case_files

- name: Create catalog sources from case files in {{ case_dir }} directory when using case files
  include: create-catalog-source-case-file.yml
  loop: "{{ case_inventories }}"
  loop_control:
    loop_var: case_inventory
  when: _use_case_files

- name: Get OpenShift storage classes to use for {{ current_cp4d_cluster.project }} and storage class name {{ current_cp4d_cluster.storage_class_name }}
  include_tasks: cp4d-get-storage-classes.yml

- name: Prepare Cloud Pak for Data operator
  include_tasks: prepare-cp4d-operator-40.yml

- name: Prepare OpenShift project {{ current_cp4d_cluster.project }} for Cloud Pak for Data
  include_tasks: openshift-prepare-project.yml

- name: Install Control Plane for Cloud Pak for Data
  include_tasks: install-control-plane-40.yml

- name: Add Cloud Pak for Data route to /etc/hosts for vSphere
  include_tasks: vsphere-configure-etc-hosts.yml
  when: cloud_platform == "vsphere"

- name: Configure CP4D admin password and store in vault
  include_tasks: configure-cpd-admin-password.yml

- name: Output Cloud pak for Data URL and admin password
  include_role:
    name: cp4d-cluster-show

# - name: Check for cp4d service definitions, skip when empty
#   debug:
#     msg: "OpenShift Project {{ current_cp4d_cluster.project }} from OpenShift cluster {{ current_cp4d_cluster.openshift_cluster_name }} on VPC {{ vpc.vpc_name }} has no cp4d_services definitions. No installation will be performed..."
#   when: current_cp4d_cluster.cp4d_services|length == 0

# TODO: Apply to CP4D 4.0
# - name: Loop through each available service and uninstall service not included in cp4d_services for OpenShift project {{ current_cp4d_cluster.project }}
#   include_role:
#     name: cp4d-service-uninstall
#   loop: "{{ all_cp4d_services }}"
#   loop_control:
#     loop_var: cp4d_service

- name: Ensure the status log folder exists
  file:
    path: "{{status_dir}}/log"
    state: directory

- name: Install selected cartridges for the cluster
  include_role:
    name: cp4d-cartridge-install

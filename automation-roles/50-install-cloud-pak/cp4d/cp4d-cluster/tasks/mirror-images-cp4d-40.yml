---
- name: Generate /tmp/auth.json
  template:
    src: auth.json.j2
    dest: "{{ status_dir }}/cp4d/auth.json"

- name: Mirror images for all files in {{ config_dir }}/case. Check status in {{ status_dir }}/log/mirror_images.log
  shell: |
    run_mirror_images() {
      {{ role_path }}/scripts/ibmcloud-roks-mirror-images.sh image mirror --dir {{ case_dir }} \
        --to-registry "{{ private_registry_url_namespace }}" \
        --auth {{ status_dir }}/cp4d/auth.json |& \
        tee -a {{ status_dir }}/log/mirror_images.log; \
        return "${PIPESTATUS[0]}"; }; \
    run_mirror_images
  register: mirror_images_result
  retries: 10
  delay: 5
  until: mirror_images_result.rc==0

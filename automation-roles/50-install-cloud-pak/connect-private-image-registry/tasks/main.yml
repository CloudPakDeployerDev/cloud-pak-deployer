---
- name: Validate mandatory variables are defined
  assert:
    that:
      - cloud_platform is defined
      - (current_cp4d_cluster.image_registry_name | default("")) != ""

- name: Validate cloud_platform is implemented
  fail: msg="cloud_platform {{ cloud_platform }} is not implemented, current implemented cloud platforms are {{ implemented_cloud_platform_types }} "
  when: "cloud_platform not in implemented_cloud_platform_types"

- name: Retrieve image registry details
  set_fact:
    current_image_registry: "{{ all_config.image_registry | json_query(query) | first | default({}) }}"
  vars:
    query: >-
      [?name=='{{ current_cp4d_cluster.image_registry_name }}']

- fail:
    msg: "Image registry details for image_registry_name {{ current_cp4d_cluster.image_registry_name }} not found."
  when: 
  - current_image_registry | default({}) == {}

- debug:
    var: current_image_registry

- name: Connect to IBM Container Registry and store credentials if needed
  block:
    - include_tasks: ibmcloud-cr-connect.yml
  when: cloud_platform == 'ibm-cloud'

- name: Get private registry authentication details
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "image-registry-{{ current_cp4d_cluster.image_registry_name }}"
    secret_group: "{{ environment_name }}"

- fail:
    msg: "Credentials for specified image registry {{ current_cp4d_cluster.image_registry_name }} not found in vault"
  when: 
  - secret_value == ""

- set_fact:
    private_registry_auth: "{{ secret_value }}"
    private_registry_url: "{{ lookup('template','get_private_registry.j2') }}"
    private_registry_url_namespace: "{{ lookup('template','get_private_registry_with_namespace.j2') }}"


---
- name: Download all assets for air-gapped install
  hosts: localhost
  connection: local
  become: True
  gather_facts: False

  vars:
    ansible_callback_diy_runner_on_skipped_msg: ""
    ansible_callback_diy_runner_on_ok_msg: ""
    ansible_callback_diy_playbook_on_include_msg: ""

  tasks:
  - name: Get IBM Entitled Registry key
    include_role: 
      name: vault-get-secret
    vars:
      secret_name: "ibm_cp_entitlement_key"
      secret_group: "{{ environment_name }}"

  - set_fact:
      ibm_cp_entitlement_key: "{{ secret_value }}"

  - name: Fail if the entitlement key was not found in the vault
    fail:
      msg: "Entitlement key must be stored in vault secret ibm_cp_entitlement_key."
    when: ibm_cp_entitlement_key == ""

  - name: Retrieve IP address of portable registry
    set_fact:
      _portable_registry_ip_address: "{{ lookup('file', status_dir + '/imageregistry/portable-registry-ip.out') }}"

  - name: Show IP address of portable registry
    debug:
      var: _portable_registry_ip_address

  - name: Wait until registry is available on IP address {{ _portable_registry_ip_address }} and port 5000
    wait_for:
      host: "{{ _portable_registry_ip_address }}"
      port: 5000
      timeout: 30

  - name: Connect to Vault
    include_role:
      name: vault-connect

  - name: "Include 'generators'-role and pass variables to it"
    include_role:
      name: generators
    vars:
      path_to_config_dir: "{{ config_dir }}"
      path_to_generators_dir: "{{ generators_dir | default([(playbook_dir | dirname),'/automation-generators'] | join) }}"

  - name: Download CLIs
    include_role:
      name: download-cli

  - name: Remove case directory in case it exists
    file:
      path: "{{ status_dir }}/cp4d/case"
      state: absent

  - name: Save case files for Cloud Pak for Data
    include_role:
      name: cp4d-case-save
    loop: "{{ all_config.cp4d | default([]) }}"
    loop_control:
      loop_var: _p_current_cp4d_cluster

  - name: Mirror images to portable image registry
    include_role:
      name: cp-mirror-images
    vars:
      _p_target_registry_hostname: "{{ _portable_registry_ip_address }}"
      _p_target_registry_port: 5000
      _p_target_registry_credentials_secret: portable-registry-credentials
      _p_case_dir: "{{ status_dir }}/cp4d/case"
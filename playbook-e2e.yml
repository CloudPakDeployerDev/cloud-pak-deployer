---
- name: Run Infrastructure automation
  hosts: localhost
  connection: local
  become: True
  gather_facts: False
  environment:
    KUBECONFIG: "{{ status_dir }}/openshift/kubeconfig_{{ environment_name }}"

  roles:
    - role: validate-variables
    - role: vault-connect
    - role: provision-terraform
    - role: nfs-server

- hosts: vpc_bastion_server
  become: True
  gather_facts: False

  roles:
    - role: nfs-server-ibmcloud-vpc-bastion

- hosts: vpc_nfs_servers
  become: True
  gather_facts: False

  roles:
    - role: nfs-server-ibmcloud-vpc-install

- name: Configure ROKS and install Cloud Pak for Data
  hosts: localhost
  connection: local
  become: True
  environment:
    KUBECONFIG: "{{ status_dir }}/openshift/kubeconfig_{{ environment_name }}"

  roles:
    - role: cli-installs
    - role: login-ibmcloud

  tasks:
  - name: Loop through each roks entry
    include_role:
      name: roks-cluster
    loop: "{{ all_config.roks | default([]) }}"
    loop_control:
      loop_var: current_roks_cluster

  - name: Loop through each cp4d entry
    include_role:
      name: cp4d-cluster
    loop: "{{ all_config.cp4ds | default([]) }}"
    loop_control:
      loop_var: current_cp4d_cluster